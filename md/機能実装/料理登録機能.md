# 料理登録機能の実装
## DBにdishesテーブルを作成

### マイグレーション・モデル作成

以下のコマンドでマイグレーションとモデルを作成
```bash
sail artisan make:model Dishes -m

# 以下はコントローラーも一緒に作成
sail artisan make:model Post -mc

# 以下はコントローラーをリソースコントローラーとして作成
sail artisan make:model Post -mcr
```
<br>

### マイグレーションを編集
```php
// 省略
public function up(): void
{
    Schema::create('dishes', function (Blueprint $table) {
        $table->id();
        //以下の２つを追記
        $table->string('name');
        $table->foreignId('user_id')
            ->constrained()->onDelete('cascade');
        $table->timestamps();
    });
}
// 省略
```
**upメソッド**に作成したいカラムを`$table->型('カラム名')->オプション`形式で書く。

`id`と`timestamps`カラムはデフォルトで設定されているので、料理名用の`name`カラムと、usersテーブルとのリレーション用の`user_id`カラムを追記。

`->constrained()->onDelete('cascade');`<br>紐づけられたuser_idのカラムが削除されたときの挙動を書いており、この場合は一緒に削除される。

`->references('id')->on('users')->onDelete('cascade');`<br>このように書くこともできる。

### DBにマイグレーション
以下のコマンドでマイグレーションを実行
```bash
sail artisan migrate
```
これによりDBにdishesテーブルを作成完了

<br>

## Dishesモデルの処理

先ほどのコマンドで作成したDishesモデルを編集
```php
// 省略
class Dishes extends Model
{
    // 以下を追記
    use HasFactory;
        protected $fillable = [
            'name',
            'user_id',
        ];
        public function user()
        {
            return $this->belongsTo(User::class);
        }
}
```
`use HasFactory;`<br>テスト用のダミーデータ作成機能のための宣言

`protected $fillable`<br>
ここに宣言したカラムはコントローラー等からデータ編集可能（ホワイトリスト）

`public function user(){`<br>
`return $this->belongsTo(User::class);`<br>
`}`<br>
リレーション処理、このメソッド名からリレーションモデルを参照できる。<br>
*belongsTo()* でこの場合dishes->usersが多対一という意味になる。

リレーションは相互に行う必要があり`Userモデル`側では以下のような処理を追記しておく。
```php
// 省略
public function dishes()
    {
        return $this->hasMany(Dishes::class);
    }
```
*hasMany()* でこの場合users->dishesが一対多という意味になる。

<br>

ここまででDBを操作する準備が整ったので、ここからは機能の処理を書いていく。

## 登録料理一覧表示画面の作成

### 一覧表示画面表示用のRouteを作成
routes/web.phpを開き、二段階認証済みのグループに以下のルートを作成
```php
Route::get('/dishes', [DishesController::class, 'index'])->name('dishes.index');
```
<br>

### Controllerの作成

以下のコマンドで、このRouteによって呼び出される`DishesController`を作成
```bash
sail artisan make:controller DishesController
```
<br>

*App/Http/Controllers/DishesController*を開き、上記のRouteによって呼び出されるindexメソッドを作成
```php
// 省略
use App\Models\Dishes; // Dishesモデルを参照する宣言を追記

class DishesController extends Controller
{
    // 以下を追記
    public function index()
    {
        $dishes = Dishes::where('user_id', auth()->id())->get();
        return view('contents', compact('dishes'));
    }
}
```
`$dishes = Dishes::where('user_id', auth()->id())->get();`<br>
dishesテーブルからuser_idが現在ログイン中のuser_idと一致するレコードを取得し、変数に格納

`return view('contents', compact('dishes'));`<br>
*contents.blade.php*を描画し、*compact()* で取得したデータ（値）を同名の変数に格納して渡す。

<br>

### Viewの作成
*resources/views*に`contents.blade.php`を作成し、以下を追記
```php
// レイアウトを考慮したタグ・スタイルは省略

@if(request()->routeIs('dishes.index'))
    @include('pages.dishes')
@endif
```
`@if(request()->routeIs('dishes.index'))`<br>
このviewを呼んだRouteが*dish.index*の場合に表示する

`@include('pages.dishes')`<br>
*pages/dishes.blade.php*を呼び出す

*resources/view/pages*に`dishes.blade.php`を作成し、以下を追記
```php
// レイアウトを考慮したタグ・スタイルは省略

<h1>登録料理一覧</h1>

@foreach($dishes as $dish)
    <p>{{$dish->name}}</p>
@endforeach
```
`@foreach($dishes as $dish)`<br>
コントローラーから渡されたデータをに対して、１つずつ処理を行う

`<p>{{$dish->name}}</p>`<br>
$dishのnameカラムの値を描画（ ✕ 全取得データ分の回数）

<br>

これでDBに料理が登録されていれば、一覧表示される画面が完成<br>
次にこれらを拡張子し、料理の登録機能を実装します。

## 料理登録機能の実装
